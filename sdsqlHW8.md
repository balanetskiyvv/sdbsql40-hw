# Домашнее задание к занятию «Резервное копирование баз данных»

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

### Ответ:
1.1. Подойдет полное резервное копирование (full backup). Все данные базы данных копируются в конце дня и хранятся на отдельных носителях или в удаленном хранилище, но не на том же сервере. В случае сбоя, данные за весь предыдущий день можно восстановить, используя последний полный бэкап.

1.2. Подойдет инкрементное резервное копирование (incremental backup). После ежедневного полного бэкапа, каждый час происходит копирование только тех данных, которые изменились с момента последнего бэкапа. Это уменьшает объем хранимых данных, но увеличивает время на восстановление, при этом позволяет восстановить базу данных почти до момента сбоя.

1.3. Да, такой сценарий возможен с применеием технологий обеспечения высокой доступности баз данных. Существует несколько основных подходов для реализации моментального переключения:  
- Репликация в реальном времени - процесс синхронного или асинхронного копирования всех изменений на вторичный сервер. При сбое основного сервера система автоматически переключается на актуальную копию данных.
- Кластеризация баз данных - объединение нескольких серверов в группу, где каждый может взять на себя функции другого в случае сбоя. Примеры: Microsoft SQL Server Always On Availability Groups, Oracle Real Application Clusters (RAC).
- Отказоустойчивые системы - специально спроектированные решения, где при сбое одного компонента другой мгновенно его заменяет без потери работы.
- Распределенные базы данных - данные хранятся на нескольких узлах в разных географических локациях. При сбое одного узла происходит автоматическое переключение на работающий.

---

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.2.* Возможно ли автоматизировать этот процесс? Если да, то как?

### Ответ:
2.1. В PostgreSQL для резервного копирования данных используется утилита pg_dump, а для восстановления — pg_restore (для бинарных бэкапов) или psql (для SQL-форматированных бэкапов). Вот примеры команд:

Резервирование данных:
```bash
pg_dump -U username -W -F c -f "/path_to_backup/backup_file.dump" dbname
```
-U username — имя пользователя, под которым будет выполнена команда.
-W — запрашивает пароль перед подключением к базе данных.
-F c — указывает формат бэкапа (в данном случае, custom).
-f — путь и имя файла для сохранения дампа.
dbname — имя базы данных, которую нужно скопировать.

Восстановление БД:
```bash
pg_restore -U username -d dbname -W -F c -C "/path_to_backup/backup_file.dump".
```
-U username — имя пользователя для подключения к базе данных.  
-d dbname — имя целевой базы данных, в которую будет восстановлен дамп.  
-W — запрашивает пароль пользователя.  
-F c — указывает формат бэкапа (custom).  
-C — создает базу данных перед восстановлением (если это необходимо).  
"/path_to_backup/backup_file.dump" — путь к файлу дампа.

2.2. Да, вот несколько способов автоматизации:
- Можно написать bash-скрипт, который будет выполнять резервное копирование по расписанию в полночь при помощи планировщика задач cron;
- PostgreSQL позволяет настроить непрерывное архивирование (Continuous Archiving) и точки восстановления (Point-In-Time Recovery, PITR);
- Интеграция с облачными сервисами;
- Использование специализированного программного обеспечения для PostgreSQL;
- Ротация бэкапов - автоматическое удаление старых копий;
- Проверка целостности резервных копий;
- Мониторинг успешности выполнения.

---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

### Ответ:
3.1. Инкрементное резервное копирование в MySQL позволяет создавать копии только измененных данных с момента последнего бэкапа, что снижает нагрузку на сервер и минимизирует риск потери данных.
Для работы с инкрементными бэкапами необходимо настроить бинарные логи в конфигурационном файле MySQL (my.cnf):
```
log_bin = /var/log/mysql/mysql-bin.log
expire_logs_days = 8
```
Первая строка активирует бинарную логирование и указывает путь для сохранения лог-файлов. Вторая строка устанавливает автоматическое удаление логов старше 8 дней.
Пример выполнения инкрементного бэкапа:
```bash
mysqlbinlog --start-datetime="2023-03-01 00:00:00" \
            --stop-datetime="2023-03-02 00:00:00" \
            --to-last-log \
            --result-file="/path_to_backup/incremental_backup.sql" \
            binlog.000001 binlog.000002 ...
```
--start-datetime и --stop-datetime определяют временной промежуток, за который нужно извлечь изменения.
--to-last-log указывает mysqlbinlog продолжить чтение бинарных логов до последнего доступного.
--result-file задает путь и имя файла для сохранения SQL-команд, извлеченных из бинарных логов.
binlog.000001 binlog.000002 ... - список бинарных логов для обработки.

3.1. Использование реплики в MySQL имеет ряд существенных преимуществ по сравнению с обычным резервным копированием:  
**Снижение нагрузки на производительность:**
- Возможность направлять операции чтения на реплика-серверы;
- Выполнение резервного копирования с реплики без влияния на основной сервер;
- Разгрузка основного сервера от запросов.  
**Высокая доступность:**
- Возможность быстрого переключения на реплика-сервер при отказе основного;
- Минимизация простоев системы;
- Автоматическое восстановление работы без потери данных.  
**Географическое распределение:**
- Размещение реплик в разных географических локациях;
- Обеспечение локальной близости данных к пользователям;
- Повышение устойчивости к региональным сбоям.
**Масштабируемость системы:**. 
- Добавление дополнительных реплик для обработки растущего объема запросов;
- Горизонтальное масштабирование для увеличения производительности;
- Распределение нагрузки между серверами.  
**Восстановление данных:**
- Возможность восстановления состояния базы на определенный момент времени;
- Использование бинарных логов для точной точки восстановления;
- Более гибкая система восстановления.  
**Аналитические задачи:**
- Выполнение тяжелых аналитических запросов на репликах;
- Запуск отчетных процессов без влияния на производительность;
- Тестирование новых функций на репликах.

Важно понимать, что репликация и резервное копирование дополняют друг друга:
- Репликация обеспечивает высокую доступность и производительность;
- Резервное копирование защищает от потери данных при серьезных сбоях.

Репликация особенно эффективна в следующих случаях:
- Когда требуется минимальное время восстановления системы;
- При необходимости распределения нагрузки между серверами;
- В системах с высокой нагрузкой на чтение;
- При работе с территориально распределенными пользователями;
- Для создания изолированной среды тестирования.

Однако стоит помнить, что репликация не заменяет резервное копирование, так как реплики могут быть подвержены тем же проблемам, что и основной сервер. Оптимальное решение - это комбинация обоих подходов для обеспечения максимальной надежности и доступности данных.
